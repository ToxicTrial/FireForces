<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–∂–∞—Ä–Ω—ã—Ö –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e2e; color: #fff; margin: 0; padding: 20px; }
        h1 { text-align: center; color: #a6e3a1; margin-bottom: 30px; }
        
        .container { display: flex; gap: 30px; justify-content: center; align-items: flex-start; }
        
        /* –°–µ–∫—Ü–∏—è –∫–∞—Ä—Ç—ã */
        .map-wrapper { text-align: center; }
        canvas { background-color: #313244; border: 2px solid #585b70; border-radius: 8px; cursor: crosshair; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        
        /* –°–µ–∫—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö */
        .data-section { width: 450px; }
        .card { background: #313244; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #45475a; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª-–≤–∞ –±–æ–π—Ü–æ–≤ */
        .table-container { max-height: 400px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead { position: sticky; top: 0; background: #313244; z-index: 2; }
        th, td { text-align: left; padding: 8px 5px; border-bottom: 1px solid #45475a; }
        th { color: #89b4fa; }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .status-ok { color: #a6e3a1; }
        .status-warning { color: #f9e2af; font-weight: bold; }
        .status-critical { color: #f38ba8; font-weight: bold; animation: blink 1s infinite; }
        
        /* –ú–µ—Ç–∫–∏ –æ—Ç—Ä—è–¥–æ–≤ */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #111; }

        @keyframes blink { 50% { opacity: 0.5; } }

        .alert-box {
            background: #f38ba8; color: #111; padding: 15px; 
            border-radius: 8px; display: none; margin-bottom: 20px; 
            text-align: center; font-weight: bold; font-size: 18px;
            box-shadow: 0 0 15px #f38ba8;
        }

        button {
            width: 100%; padding: 12px; background: #fab387; border: none; 
            color: #111; font-weight: bold; border-radius: 5px; cursor: pointer; transition: 0.2s;
        }
        button:hover { background: #f9e2af; }
    </style>
</head>
<body>

    <h1>üöë –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∂–∞—Ä–Ω—ã–º–∏ —Å–∏–ª–∞–º–∏</h1>

    <div class="alert-box" id="globalAlert">üö® –í–ù–ò–ú–ê–ù–ò–ï: –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –õ–ò–ß–ù–û–ì–û –°–û–°–¢–ê–í–ê!</div>

    <div class="container">
        <!-- –ö–∞—Ä—Ç–∞ -->
        <div class="map-wrapper">
            <canvas id="fireMap" width="500" height="500"></canvas>
            <p style="color: #7f849c; margin-top: 10px;">–õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏ ‚Äî –ø–æ–¥–∂–æ–≥</p>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ -->
        <div class="data-section">
            <div class="card">
                <button onclick="startRandomFire()">üî• –ò–º–∏—Ç–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤–æ–∑–≥–æ—Ä–∞–Ω–∏—è</button>
            </div>
            
            <div class="card">
                <h3 style="margin-top:0;">–°–≤–æ–¥–∫–∞ –ø–æ –æ—Ç—Ä—è–¥–∞–º</h3>
                <div class="table-container">
                    <table id="ffTable">
                        <thead>
                            <tr>
                                <th>–û—Ç—Ä—è–¥</th>
                                <th>ID</th>
                                <th>‚ù§Ô∏è –ü—É–ª—å—Å</th>
                                <th>üå°Ô∏è T¬∞C</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- –î–∞–Ω–Ω—ã–µ JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('fireMap');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const cellSize = canvas.width / gridSize;

        function startRandomFire() {
            fetch('/api/spark', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}'});
        }

        canvas.onclick = function(event) {
            const rect = canvas.getBoundingClientRect();
            const x = Math.floor((event.clientX - rect.left) / cellSize);
            const y = Math.floor((event.clientY - rect.top) / cellSize);
            fetch('/api/spark', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({x: x, y: y})
            });
        };

        function drawMap(grid) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for(let y=0; y<gridSize; y++) {
                for(let x=0; x<gridSize; x++) {
                    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–≥–Ω—è
                    if(grid[y][x] > 0) {
                        const intensity = grid[y][x] / 100;
                        // –ì—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç –∂–µ–ª—Ç–æ–≥–æ –∫ –∫—Ä–∞—Å–Ω–æ–º—É
                        const red = 255;
                        const green = Math.floor(165 * (1 - intensity)); 
                        ctx.fillStyle = `rgba(${red}, ${green}, 0, ${0.4 + intensity*0.6})`;
                        ctx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
                    }
                    // –°–µ—Ç–∫–∞
                    ctx.strokeStyle = '#383a4a';
                    ctx.strokeRect(x*cellSize, y*cellSize, cellSize, cellSize);
                }
            }
        }

        function drawFirefighters(list) {
            let criticalExists = false;
            const tbody = document.querySelector('#ffTable tbody');
            tbody.innerHTML = '';

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ ID –¥–ª—è –ø–æ—Ä—è–¥–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ
            list.sort((a,b) => a.id - b.id);

            list.forEach(ff => {
                // 1. –†–∏—Å—É–µ–º –Ω–∞ –∫–∞—Ä—Ç–µ
                ctx.fillStyle = ff.color;
                
                // –†–∏—Å—É–µ–º –∫—Ä—É–≥ (–±–æ–µ—Ü)
                ctx.beginPath();
                ctx.arc(ff.x*cellSize + cellSize/2, ff.y*cellSize + cellSize/2, cellSize/2.5, 0, Math.PI*2);
                ctx.fill();
                
                // –ï—Å–ª–∏ —Ç—É—à–∏—Ç - —Ä–∏—Å—É–µ–º –≥–æ–ª—É–±—É—é —Ä–∞–º–∫—É
                if (ff.action === 'extinguishing') {
                    ctx.strokeStyle = '#00ffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.lineWidth = 1;
                }

                // ID –±–æ–π—Ü–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
                ctx.fillStyle = '#000';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(ff.id, ff.x*cellSize + cellSize/2, ff.y*cellSize + cellSize/2 + 3);

                // 2. –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É
                const row = `<tr>
                    <td><span class="badge" style="background-color: ${ff.color}">${ff.squad}</span></td>
                    <td><b>${ff.id}</b></td>
                    <td>${ff.pulse}</td>
                    <td>${ff.temp.toFixed(1)}</td>
                    <td class="status-${ff.status.toLowerCase()}">${ff.status}</td>
                </tr>`;
                tbody.innerHTML += row;

                if (ff.status === 'CRITICAL') criticalExists = true;
            });

            const alertBox = document.getElementById('globalAlert');
            alertBox.style.display = criticalExists ? 'block' : 'none';
        }

        function updateData() {
            fetch('/api/data')
                .then(res => res.json())
                .then(data => {
                    drawMap(data.grid);
                    drawFirefighters(data.firefighters);
                })
                .catch(err => console.error(err));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É
        setInterval(updateData, 1000);
        updateData();
    </script>
</body>
</html>